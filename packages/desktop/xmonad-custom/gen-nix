#!/usr/bin/env bash

set -eu

runtime_packages=($(grep --perl '{{.*(?<!out)}}' src/Xmonad.hs | sed -e 's|.*{{\(.*\)}}/.*|\1|' | sort -u))
compiletime_packages=(
    wrapGAppsHook
    gdk-pixbuf
)

extra_args=( )
for p in "${runtime_packages[@]}" "${compiletime_packages[@]}"; do
    extra_args+=(--extra-arguments "$p")
done

echo "#"
echo "# DO NOT EDIT - generated by gen-nix"
echo "#"

cabal2nix . "${extra_args[@]}" \
    | head -n-1

echo "  executableSystemDepends = ["
for p in "${compiletime_packages[@]}"; do
    echo "    ${p}"
done
echo "  ];"
echo "  postPatch = ''";
for hs in src/Xmonad.hs; do
    echo "    substituteInPlace $hs \\"
    if grep -q '{{out}}' "$hs"; then
        echo "      --replace-fail '{{out}}' \"\$out\" \\"
    fi
    for p in "${runtime_packages[@]}"; do
        echo "      --replace-fail '{{$p}}' '\${$p}' \\"
    done
    echo "    ;"
done
echo "  '';"

echo "}"
